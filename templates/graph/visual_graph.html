{% extends "base.html" %}

{% block title %}File Relationship Graph - Arweave Puzzle #11{% endblock %}

{% block extra_head %}
<style>
    #graph-container {
        height: 75vh;
        border: 1px solid #e5e5e5;
        border-radius: 8px;
        position: relative;
    }

    .graph-toolbar {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 1000;
        background: white;
        padding: 8px;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        gap: 4px;
    }

    .toolbar-btn {
        padding: 4px 8px;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
    }

    .toolbar-btn:hover {
        background: #f3f4f6;
    }

    .toolbar-btn.active {
        background: #3b82f6;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-4">
    <!-- Compact Header -->
    <div class="bg-white rounded-lg shadow-sm p-4">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold text-gray-900">File Relationship Graph</h1>
                <p class="text-sm text-gray-600">Interactive visualization of file relationships</p>
            </div>
            <div class="flex space-x-2">
                <button id="load-sample-data" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-plus mr-1"></i>Load Sample
                </button>
                <button id="export-graph" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-download mr-1"></i>Export
                </button>
            </div>
        </div>
    </div>

    <!-- Graph Canvas -->
    <div class="bg-white rounded-lg shadow-sm p-4">
        <div class="relative">
            <!-- Graph Toolbar -->
            <div class="graph-toolbar">
                <button id="fit-graph" class="toolbar-btn" title="Fit to screen">
                    <i class="fas fa-expand-arrows-alt"></i>
                </button>
                <button id="add-node" class="toolbar-btn" title="Add node">
                    <i class="fas fa-plus"></i>
                </button>
                <button id="delete-selected" class="toolbar-btn" title="Delete selected">
                    <i class="fas fa-trash"></i>
                </button>
            </div>

            <div id="graph-container"></div>

            <div class="mt-3 flex items-center justify-between text-sm text-gray-600">
                <div id="graph-stats">
                    <span id="visible-nodes">0</span> nodes,
                    <span id="visible-edges">0</span> edges
                </div>
                <div id="selection-info" class="hidden">
                    Selected: <span id="selected-items"></span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let network;
let nodes, edges;
let networkData = {
    nodes: {{ nodes|safe if nodes else '[]' }},
    edges: {{ edges|safe if edges else '[]' }}
};

document.addEventListener('DOMContentLoaded', function() {
    initializeGraph();
    setupEventListeners();
});

function initializeGraph() {
    const container = document.getElementById('graph-container');

    // Create datasets
    nodes = new vis.DataSet(networkData.nodes);
    edges = new vis.DataSet(networkData.edges);

    const data = { nodes: nodes, edges: edges };

    const options = {
        physics: {
            enabled: true,
            stabilization: { iterations: 100 }
        },
        nodes: {
            borderWidth: 2,
            shadow: true,
            font: { size: 12 },
            scaling: { min: 15, max: 35 }
        },
        edges: {
            width: 2,
            shadow: true,
            arrows: { to: { enabled: true } },
            font: { size: 10, background: 'white' }
        },
        interaction: {
            hover: true,
            selectConnectedEdges: false
        }
    };

    network = new vis.Network(container, data, options);

    // Event handlers
    network.on("click", function(params) {
        updateSelection();
    });

    network.on("doubleClick", function(params) {
        if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            const node = nodes.get(nodeId);
            if (node.sha) {
                window.open(`/files/${node.sha}`, '_blank');
            }
        }
    });

    updateGraphStats();

    // If no data, load sample
    if (networkData.nodes.length === 0) {
        loadSampleData();
    }
}

function setupEventListeners() {
    document.getElementById('fit-graph').addEventListener('click', () => {
        network.fit();
    });

    document.getElementById('load-sample-data').addEventListener('click', loadSampleData);
    document.getElementById('export-graph').addEventListener('click', exportGraph);
    document.getElementById('add-node').addEventListener('click', addSampleNode);
    document.getElementById('delete-selected').addEventListener('click', deleteSelected);
}

function loadSampleData() {
    // Create sample nodes and edges for demonstration
    const sampleNodes = [
        {
            id: 1,
            label: 'root_image.png',
            sha: 'abc123...',
            color: '#fbbf24',
            shape: 'diamond',
            title: 'Root file: root_image.png',
            is_root: true
        },
        {
            id: 2,
            label: 'extracted_data.bin',
            sha: 'def456...',
            color: '#3b82f6',
            title: 'Extracted: extracted_data.bin'
        },
        {
            id: 3,
            label: 'hidden_text.txt',
            sha: 'ghi789...',
            color: '#22c55e',
            title: 'Text file: hidden_text.txt'
        }
    ];

    const sampleEdges = [
        {
            id: 'e1',
            from: 1,
            to: 2,
            label: 'zsteg -a',
            color: '#ef4444',
            title: 'ZSteg extraction'
        },
        {
            id: 'e2',
            from: 2,
            to: 3,
            label: 'strings',
            color: '#22c55e',
            title: 'String extraction'
        }
    ];

    nodes.clear();
    edges.clear();
    nodes.add(sampleNodes);
    edges.add(sampleEdges);

    updateGraphStats();
    network.fit();

    showNotification('Sample data loaded', 'success');
}

function addSampleNode() {
    const newId = nodes.length + Math.random() * 1000;
    const newNode = {
        id: newId,
        label: `file_${Math.floor(Math.random() * 1000)}.bin`,
        sha: `${Math.random().toString(36).substring(7)}...`,
        color: '#6366f1',
        title: 'Sample file'
    };

    nodes.add(newNode);
    updateGraphStats();

    showNotification('Node added', 'success');
}

function deleteSelected() {
    const selectedNodes = network.getSelectedNodes();
    const selectedEdges = network.getSelectedEdges();

    if (selectedNodes.length === 0 && selectedEdges.length === 0) {
        showNotification('No items selected', 'warning');
        return;
    }

    if (confirm(`Delete ${selectedNodes.length} nodes and ${selectedEdges.length} edges?`)) {
        if (selectedNodes.length > 0) {
            nodes.remove(selectedNodes);
        }
        if (selectedEdges.length > 0) {
            edges.remove(selectedEdges);
        }

        updateGraphStats();
        showNotification('Items deleted', 'success');
    }
}

function updateSelection() {
    const selectedNodes = network.getSelectedNodes();
    const selectedEdges = network.getSelectedEdges();
    const selectionInfo = document.getElementById('selection-info');

    if (selectedNodes.length > 0 || selectedEdges.length > 0) {
        const items = [];
        if (selectedNodes.length > 0) items.push(`${selectedNodes.length} nodes`);
        if (selectedEdges.length > 0) items.push(`${selectedEdges.length} edges`);

        document.getElementById('selected-items').textContent = items.join(', ');
        selectionInfo.classList.remove('hidden');
    } else {
        selectionInfo.classList.add('hidden');
    }
}

function updateGraphStats() {
    document.getElementById('visible-nodes').textContent = nodes.length;
    document.getElementById('visible-edges').textContent = edges.length;
}

function exportGraph() {
    const canvas = network.canvas.frame.canvas;
    const link = document.createElement('a');
    link.download = 'file-relationship-graph.png';
    link.href = canvas.toDataURL();
    link.click();

    showNotification('Graph exported', 'success');
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-3 rounded-md shadow-lg text-sm ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        type === 'warning' ? 'bg-yellow-500' :
        'bg-blue-500'
    } text-white`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => notification.remove(), 3000);
}
</script>
{% endblock %}