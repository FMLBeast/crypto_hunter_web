{% extends "base.html" %}

{% block title %}Files - Arweave Puzzle #11{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">File Collection</h1>
                <p class="mt-1 text-gray-600">Browse and search through the analyzed files</p>
            </div>
            <div class="flex space-x-4">
                <a href="{{ url_for('files.add_file') }}" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md font-medium">
                    <i class="fas fa-plus mr-2"></i>Add File
                </a>
                <a href="{{ url_for('files.bulk_import') }}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium">
                    <i class="fas fa-upload mr-2"></i>Bulk Import
                </a>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white rounded-lg shadow p-6">
        <form method="GET" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Search by filename -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search Files</label>
                    <input type="text" name="search" value="{{ search }}" placeholder="Search by filename..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                
                <!-- SHA search -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">SHA Hash</label>
                    <input type="text" name="sha" value="{{ sha_search }}" placeholder="SHA256 hash..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <!-- Status filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">All Statuses</option>
                        <option value="pending" {{ 'selected' if status_filter == 'pending' }}>Pending</option>
                        <option value="analyzing" {{ 'selected' if status_filter == 'analyzing' }}>Analyzing</option>
                        <option value="complete" {{ 'selected' if status_filter == 'complete' }}>Complete</option>
                        <option value="error" {{ 'selected' if status_filter == 'error' }}>Error</option>
                    </select>
                </div>

                <!-- File type filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">File Type</label>
                    <select name="file_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">All Types</option>
                        {% for file_type in file_types %}
                        <option value="{{ file_type }}" {{ 'selected' if file_type_filter == file_type }}>{{ file_type }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="root_only" value="true" {{ 'checked' if root_only }} 
                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <span class="ml-2 text-sm text-gray-700">Root files only</span>
                    </label>
                </div>
                <div class="flex space-x-2">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md font-medium">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                    <a href="{{ url_for('files.file_list') }}" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md font-medium">
                        <i class="fas fa-times mr-2"></i>Clear
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- File List -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">
                Files ({{ files.total }} total, showing {{ files.items|length }})
            </h2>
        </div>

        {% if files.items %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SHA256</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for file in files.items %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    {% if file.is_root_file %}
                                        <i class="fas fa-gem text-purple-500 text-lg"></i>
                                    {% else %}
                                        <i class="fas fa-file text-gray-400"></i>
                                    {% endif %}
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">
                                        <a href="{{ url_for('files.file_detail', sha=file.sha256_hash) }}" 
                                           class="hover:text-indigo-600">
                                            {{ file.filename[:50] }}{% if file.filename|length > 50 %}...{% endif %}
                                        </a>
                                    </div>
                                    {% if file.extraction_method and file.extraction_method != 'unknown' %}
                                    <div class="text-sm text-gray-500">
                                        <i class="fas fa-arrow-right mr-1"></i>{{ file.extraction_method }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-mono text-gray-900">
                                <button onclick="copyToClipboard('{{ file.sha256_hash }}')" 
                                        class="hover:bg-gray-100 p-1 rounded" title="Click to copy">
                                    {{ file.sha256_hash[:16] }}...
                                </button>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                {{ file.file_type.split('/')[-1] if '/' in file.file_type else file.file_type }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {% if file.file_size %}
                                {% if file.file_size < 1024 %}
                                    {{ file.file_size }} B
                                {% elif file.file_size < 1024*1024 %}
                                    {{ "%.1f"|format(file.file_size/1024) }} KB
                                {% elif file.file_size < 1024*1024*1024 %}
                                    {{ "%.1f"|format(file.file_size/(1024*1024)) }} MB
                                {% else %}
                                    {{ "%.1f"|format(file.file_size/(1024*1024*1024)) }} GB
                                {% endif %}
                            {% else %}
                                Unknown
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                {% if file.status == 'complete' %}bg-green-100 text-green-800
                                {% elif file.status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif file.status == 'analyzing' %}bg-blue-100 text-blue-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ file.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <a href="{{ url_for('files.file_detail', sha=file.sha256_hash) }}" 
                               class="text-indigo-600 hover:text-indigo-900">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{{ url_for('content.file_content', sha=file.sha256_hash) }}" 
                               class="text-green-600 hover:text-green-900" title="View Content">
                                <i class="fas fa-file-code"></i>
                            </a>
                            <a href="{{ url_for('graph.graph_focus', sha=file.sha256_hash) }}" 
                               class="text-purple-600 hover:text-purple-900" title="View Graph">
                                <i class="fas fa-project-diagram"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if files.pages > 1 %}
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                {% if files.has_prev %}
                <a href="{{ url_for('files.file_list', page=files.prev_num, search=search, sha=sha_search, status=status_filter, file_type=file_type_filter, root_only=root_only) }}" 
                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Previous
                </a>
                {% endif %}
                {% if files.has_next %}
                <a href="{{ url_for('files.file_list', page=files.next_num, search=search, sha=sha_search, status=status_filter, file_type=file_type_filter, root_only=root_only) }}" 
                   class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Next
                </a>
                {% endif %}
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing <span class="font-medium">{{ files.per_page * (files.page - 1) + 1 }}</span>
                        to <span class="font-medium">{{ files.per_page * (files.page - 1) + files.items|length }}</span>
                        of <span class="font-medium">{{ files.total }}</span> results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        {% if files.has_prev %}
                        <a href="{{ url_for('files.file_list', page=files.prev_num, search=search, sha=sha_search, status=status_filter, file_type=file_type_filter, root_only=root_only) }}" 
                           class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        {% endif %}
                        
                        {% for page_num in files.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != files.page %}
                                <a href="{{ url_for('files.file_list', page=page_num, search=search, sha=sha_search, status=status_filter, file_type=file_type_filter, root_only=root_only) }}" 
                                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    {{ page_num }}
                                </a>
                                {% else %}
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-indigo-50 text-sm font-medium text-indigo-600">
                                    {{ page_num }}
                                </span>
                                {% endif %}
                            {% else %}
                            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                ...
                            </span>
                            {% endif %}
                        {% endfor %}
                        
                        {% if files.has_next %}
                        <a href="{{ url_for('files.file_list', page=files.next_num, search=search, sha=sha_search, status=status_filter, file_type=file_type_filter, root_only=root_only) }}" 
                           class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-folder-open text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No files found</h3>
            <p class="text-gray-600 mb-4">Try adjusting your search criteria or import some files.</p>
            <div class="space-x-4">
                <a href="{{ url_for('files.add_file') }}" class="text-indigo-600 hover:text-indigo-800">Add a file</a>
                <a href="{{ url_for('files.bulk_import') }}" class="text-indigo-600 hover:text-indigo-800">Bulk import</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}