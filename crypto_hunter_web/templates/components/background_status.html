<!-- Background Processing Status Widget -->
<div class="bg-white rounded-lg shadow-sm p-4">
    <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold text-gray-900">Background Crypto Analysis</h3>
        <div class="flex space-x-2">
            <button id="start-background" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                <i class="fas fa-play mr-1"></i>Start
            </button>
            <button id="refresh-status" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                <i class="fas fa-sync mr-1"></i>Refresh
            </button>
        </div>
    </div>

    <!-- System Status -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
        <div class="text-center">
            <div id="active-tasks" class="text-2xl font-bold text-green-600">0</div>
            <div class="text-xs text-gray-500">Active Tasks</div>
        </div>
        <div class="text-center">
            <div id="queued-tasks" class="text-2xl font-bold text-blue-600">0</div>
            <div class="text-xs text-gray-500">Queued</div>
        </div>
        <div class="text-center">
            <div id="ethereum-queue" class="text-2xl font-bold text-purple-600">0</div>
            <div class="text-xs text-gray-500">Ethereum Queue</div>
        </div>
        <div class="text-center">
            <div id="cipher-queue" class="text-2xl font-bold text-orange-600">0</div>
            <div class="text-xs text-gray-500">Cipher Queue</div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="border-t pt-3">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Recent Activity</h4>
        <div id="recent-activity" class="space-y-1 max-h-32 overflow-y-auto">
            <!-- Activity items populated by JS -->
        </div>
    </div>

    <!-- Progress Indicators -->
    <div id="progress-indicators" class="mt-4 space-y-2 hidden">
        <!-- Progress bars for active tasks -->
    </div>
</div>

<script>
class BackgroundStatusManager {
    constructor() {
        this.updateInterval = null;
        this.init();
    }

    init() {
        document.getElementById('start-background').addEventListener('click', this.startBackgroundProcessing.bind(this));
        document.getElementById('refresh-status').addEventListener('click', this.updateStatus.bind(this));

        // Auto-update every 10 seconds
        this.updateStatus();
        this.updateInterval = setInterval(this.updateStatus.bind(this), 10000);
    }

    async startBackgroundProcessing() {
        try {
            const response = await fetch('/background_api/background/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                showNotification(`Background processing started for ${data.queued_files} files`, 'success');
                this.updateStatus();
            } else {
                showNotification(data.error || 'Failed to start background processing', 'error');
            }
        } catch (error) {
            console.error('Start background processing error:', error);
            showNotification('Error starting background processing', 'error');
        }
    }

    async updateStatus() {
        try {
            const response = await fetch('/background_api/background/system/stats');
            const data = await response.json();

            if (data.success) {
                this.displayStats(data.stats);
            }
        } catch (error) {
            console.error('Status update error:', error);
        }
    }

    displayStats(stats) {
        // Update counters
        const activeTasks = Object.values(stats.active_tasks || {}).flat().length;
        const queueLengths = stats.queue_lengths || {};

        document.getElementById('active-tasks').textContent = activeTasks;
        document.getElementById('queued-tasks').textContent =
            Object.values(queueLengths).reduce((sum, count) => sum + count, 0);
        document.getElementById('ethereum-queue').textContent = queueLengths.ethereum || 0;
        document.getElementById('cipher-queue').textContent = queueLengths.cipher || 0;

        // Update recent activity
        this.updateRecentActivity(stats);
    }

    updateRecentActivity(stats) {
        const activityDiv = document.getElementById('recent-activity');
        const activities = [];

        // Parse active tasks for activity
        for (const [worker, tasks] of Object.entries(stats.active_tasks || {})) {
            for (const task of tasks.slice(0, 3)) {  // Show max 3 per worker
                activities.push({
                    type: task.name || 'unknown',
                    worker: worker,
                    time: new Date().toLocaleTimeString(),
                    id: task.id
                });
            }
        }

        if (activities.length === 0) {
            activityDiv.innerHTML = '<div class="text-sm text-gray-500">No active tasks</div>';
        } else {
            activityDiv.innerHTML = activities.map(activity => `
                <div class="flex items-center justify-between text-xs">
                    <span class="text-gray-700">${this.formatTaskName(activity.type)}</span>
                    <span class="text-gray-500">${activity.time}</span>
                </div>
            `).join('');
        }
    }

    formatTaskName(taskName) {
        const names = {
            'analyze_file_comprehensive': 'Comprehensive Analysis',
            'ethereum_comprehensive_analysis': 'Ethereum Analysis',
            'cipher_comprehensive_analysis': 'Cipher Analysis',
            'hash_cracking_analysis': 'Hash Cracking'
        };

        return names[taskName] || taskName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    destroy() {
        if (this.updateInterval) {
            clearInterval(this.updateInterval);
        }
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    window.backgroundStatusManager = new BackgroundStatusManager();
});
</script>