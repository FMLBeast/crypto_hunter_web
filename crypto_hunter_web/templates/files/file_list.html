{% extends "base.html" %}

{% block title %}Files - Crypto Hunter{% endblock %}

{% block extra_head %}
<style>
.filter-tag {
    transition: all 0.2s ease;
}
.filter-tag:hover {
    transform: translateY(-1px);
}
.file-row {
    transition: all 0.2s ease;
}
.file-row:hover {
    background-color: #f8fafc;
    transform: translateX(2px);
}
.search-highlight {
    background-color: #fef3c7;
    padding: 1px 2px;
    border-radius: 2px;
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">File Management</h1>
                <p class="mt-1 text-sm text-gray-600">
                    Manage and analyze your steganography files
                </p>
            </div>
            <div class="flex space-x-3">
                <a href="{{ url_for('files.upload') }}" 
                   class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md font-medium flex items-center">
                    <i class="fas fa-upload mr-2"></i>Upload Files
                </a>
                <button onclick="startBatchAnalysis()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium flex items-center">
                    <i class="fas fa-play mr-2"></i>Batch Analysis
                </button>
            </div>
        </div>
    </div>

    <!-- Advanced Search Component -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="space-y-4">
            <!-- Main Search Bar -->
            <div class="relative">
                <div class="flex">
                    <div class="relative flex-1">
                        <input type="text" id="hyperfast-search" value="{{ search or '' }}"
                               placeholder="Hyperfast search: filename, SHA, patterns, content..."
                               class="w-full px-4 py-2 pr-12 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                    <button id="search-btn" onclick="performSearch()"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-r-md">
                        Search
                    </button>
                    <button id="magic-search-btn" onclick="performMagicSearch()"
                            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 ml-2 rounded">
                        Magic
                    </button>
                </div>

                <!-- Search Suggestions -->
                <div id="search-suggestions" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 hidden">
                    <!-- Suggestions populated by JS -->
                </div>
            </div>

            <!-- Advanced Filters Row -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                <select id="filter-type" onchange="updateFilters()" class="px-3 py-2 border border-gray-300 rounded text-sm">
                    <option value="">All Types</option>
                    <option value="image" {% if file_type_filter == 'image' %}selected{% endif %}>Images</option>
                    <option value="text" {% if file_type_filter == 'text' %}selected{% endif %}>Text</option>
                    <option value="binary" {% if file_type_filter == 'binary' %}selected{% endif %}>Binary</option>
                    <option value="archive" {% if file_type_filter == 'archive' %}selected{% endif %}>Archives</option>
                    <option value="document" {% if file_type_filter == 'document' %}selected{% endif %}>Documents</option>
                </select>

                <select id="filter-status" onchange="updateFilters()" class="px-3 py-2 border border-gray-300 rounded text-sm">
                    <option value="">All Status</option>
                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="complete" {% if status_filter == 'complete' %}selected{% endif %}>Complete</option>
                    <option value="analyzing" {% if status_filter == 'analyzing' %}selected{% endif %}>Analyzing</option>
                    <option value="error" {% if status_filter == 'error' %}selected{% endif %}>Error</option>
                </select>

                <select id="filter-size" onchange="updateFilters()" class="px-3 py-2 border border-gray-300 rounded text-sm">
                    <option value="">All Sizes</option>
                    <option value="small">< 1MB</option>
                    <option value="medium">1MB - 10MB</option>
                    <option value="large">10MB - 100MB</option>
                    <option value="huge">> 100MB</option>
                </select>

                <select id="filter-root" onchange="updateFilters()" class="px-3 py-2 border border-gray-300 rounded text-sm">
                    <option value="">All Files</option>
                    <option value="root" {% if root_only %}selected{% endif %}>Root Files Only</option>
                    <option value="extracted">Extracted Only</option>
                </select>

                <input type="date" id="filter-date-from" onchange="updateFilters()" 
                       class="px-3 py-2 border border-gray-300 rounded text-sm"
                       placeholder="From Date">

                <input type="date" id="filter-date-to" onchange="updateFilters()" 
                       class="px-3 py-2 border border-gray-300 rounded text-sm"
                       placeholder="To Date">
            </div>

            <!-- Active Filters Display -->
            <div id="active-filters" class="flex flex-wrap gap-2">
                {% if search %}
                <span class="filter-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
                    Search: "{{ search }}"
                    <button onclick="clearFilter('search')" class="ml-2 text-blue-600 hover:text-blue-800">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
                {% endif %}
                {% if file_type_filter %}
                <span class="filter-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">
                    Type: {{ file_type_filter }}
                    <button onclick="clearFilter('file_type')" class="ml-2 text-green-600 hover:text-green-800">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
                {% endif %}
                {% if status_filter %}
                <span class="filter-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-yellow-100 text-yellow-800">
                    Status: {{ status_filter }}
                    <button onclick="clearFilter('status')" class="ml-2 text-yellow-600 hover:text-yellow-800">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
                {% endif %}
                {% if root_only %}
                <span class="filter-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-purple-100 text-purple-800">
                    Root Files Only
                    <button onclick="clearFilter('root_only')" class="ml-2 text-purple-600 hover:text-purple-800">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- File Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center">
                <div class="p-2 bg-blue-100 rounded-lg">
                    <i class="fas fa-file text-blue-600"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">Total Files</p>
                    <p class="text-lg font-semibold text-gray-900">{{ files.total }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center">
                <div class="p-2 bg-green-100 rounded-lg">
                    <i class="fas fa-check-circle text-green-600"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">Analyzed</p>
                    <p class="text-lg font-semibold text-gray-900">{{ analyzed_count }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center">
                <div class="p-2 bg-yellow-100 rounded-lg">
                    <i class="fas fa-clock text-yellow-600"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">Pending</p>
                    <p class="text-lg font-semibold text-gray-900">{{ pending_count }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-center">
                <div class="p-2 bg-purple-100 rounded-lg">
                    <i class="fas fa-gem text-purple-600"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">Root Files</p>
                    <p class="text-lg font-semibold text-gray-900">{{ root_count }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- File List -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-medium text-gray-900">
                    Files ({{ files.total }} total, showing {{ files.items|length }})
                </h2>
                <div class="flex items-center space-x-2">
                    <select id="sort-by" onchange="updateSort()" class="text-sm border border-gray-300 rounded px-2 py-1">
                        <option value="created_at">Sort by Date</option>
                        <option value="filename">Sort by Name</option>
                        <option value="file_size">Sort by Size</option>
                        <option value="status">Sort by Status</option>
                    </select>
                    <select id="sort-order" onchange="updateSort()" class="text-sm border border-gray-300 rounded px-2 py-1">
                        <option value="desc">Descending</option>
                        <option value="asc">Ascending</option>
                    </select>
                </div>
            </div>
        </div>

        {% if files.items %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <input type="checkbox" id="select-all" onchange="toggleSelectAll()" class="mr-2">
                            File
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SHA256</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for file in files.items %}
                    <tr class="file-row" data-file-id="{{ file.id }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <input type="checkbox" class="file-checkbox mr-3" value="{{ file.id }}">
                                <div class="flex-shrink-0">
                                    {% if file.is_root_file %}
                                        <i class="fas fa-gem text-purple-500 text-lg" title="Root File"></i>
                                    {% elif file.file_type == 'image' %}
                                        <i class="fas fa-image text-blue-500"></i>
                                    {% elif file.file_type == 'archive' %}
                                        <i class="fas fa-file-archive text-yellow-500"></i>
                                    {% elif file.file_type == 'text' %}
                                        <i class="fas fa-file-alt text-green-500"></i>
                                    {% else %}
                                        <i class="fas fa-file text-gray-400"></i>
                                    {% endif %}
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">
                                        <a href="{{ url_for('files.file_detail', sha=file.sha256_hash) }}" 
                                           class="hover:text-indigo-600">
                                            {{ file.filename }}
                                        </a>
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        {{ file.created_at.strftime('%Y-%m-%d %H:%M') }}
                                        {% if file.findings.count() > 0 %}
                                            <span class="ml-2 inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                {{ file.findings.count() }} findings
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900 font-mono">
                                <span class="cursor-pointer" onclick="copyToClipboard('{{ file.sha256_hash }}')" 
                                      title="Click to copy">
                                    {{ file.sha256_hash[:16] }}...
                                </span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                {% if file.file_type == 'image' %}bg-blue-100 text-blue-800
                                {% elif file.file_type == 'archive' %}bg-yellow-100 text-yellow-800
                                {% elif file.file_type == 'text' %}bg-green-100 text-green-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ file.file_type or file.mime_type or 'Unknown' }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {% if file.file_size %}
                                {% if file.file_size < 1024 %}
                                    {{ file.file_size }} B
                                {% elif file.file_size < 1024*1024 %}
                                    {{ "%.1f"|format(file.file_size / 1024) }} KB
                                {% elif file.file_size < 1024*1024*1024 %}
                                    {{ "%.1f"|format(file.file_size / (1024*1024)) }} MB
                                {% else %}
                                    {{ "%.2f"|format(file.file_size / (1024*1024*1024)) }} GB
                                {% endif %}
                            {% else %}
                                Unknown
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                {% if file.status == 'complete' %}bg-green-100 text-green-800
                                {% elif file.status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif file.status == 'analyzing' %}bg-blue-100 text-blue-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {% if file.status == 'analyzing' %}
                                    <div class="spinner mr-1"></div>
                                {% endif %}
                                {{ file.status.title() }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if file.status == 'complete' %}
                                <div class="flex items-center">
                                    <div class="w-16 bg-gray-200 rounded-full h-2">
                                        <div class="bg-green-500 h-2 rounded-full" style="width: 100%"></div>
                                    </div>
                                    <span class="ml-2 text-xs text-gray-500">100%</span>
                                </div>
                            {% elif file.status == 'analyzing' %}
                                <div class="flex items-center">
                                    <div class="w-16 bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-500 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                                    </div>
                                    <span class="ml-2 text-xs text-gray-500">60%</span>
                                </div>
                            {% else %}
                                <div class="flex items-center">
                                    <div class="w-16 bg-gray-200 rounded-full h-2">
                                        <div class="bg-gray-300 h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                    <span class="ml-2 text-xs text-gray-500">0%</span>
                                </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <a href="{{ url_for('files.file_detail', sha=file.sha256_hash) }}" 
                               class="text-indigo-600 hover:text-indigo-900" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{{ url_for('content.file_content', sha=file.sha256_hash) }}" 
                               class="text-green-600 hover:text-green-900" title="View Content">
                                <i class="fas fa-file-code"></i>
                            </a>
                            <a href="{{ url_for('graph.graph_focus', sha=file.sha256_hash) }}" 
                               class="text-purple-600 hover:text-purple-900" title="View Graph">
                                <i class="fas fa-project-diagram"></i>
                            </a>
                            {% if file.status == 'pending' %}
                            <button onclick="analyzeFile('{{ file.sha256_hash }}')" 
                                    class="text-blue-600 hover:text-blue-900" title="Start Analysis">
                                <i class="fas fa-play"></i>
                            </button>
                            {% endif %}
                            <button onclick="downloadFile('{{ file.sha256_hash }}')" 
                                    class="text-gray-600 hover:text-gray-900" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if files.pages > 1 %}
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                {% if files.has_prev %}
                <a href="{{ url_for('files.file_list', page=files.prev_num, search=search, sha=sha_search, status=status_filter, file_type=file_type_filter, root_only=root_only) }}" 
                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Previous
                </a>
                {% endif %}
                {% if files.has_next %}
                <a href="{{ url_for('files.file_list', page=files.next_num, search=search, sha=sha_search, status=status_filter, file_type=file_type_filter, root_only=root_only) }}" 
                   class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Next
                </a>
                {% endif %}
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing <span class="font-medium">{{ files.per_page * (files.page - 1) + 1 }}</span>
                        to <span class="font-medium">{{ files.per_page * (files.page - 1) + files.items|length }}</span>
                        of <span class="font-medium">{{ files.total }}</span> results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        {% if files.has_prev %}
                        <a href="{{ url_for('files.file_list', page=files.prev_num, search=search, sha=sha_search, status=status_filter, file_type=file_type_filter, root_only=root_only) }}" 
                           class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        {% endif %}
                        
                        {% for page_num in files.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != files.page %}
                                <a href="{{ url_for('files.file_list', page=page_num, search=search, sha=sha_search, status=status_filter, file_type=file_type_filter, root_only=root_only) }}" 
                                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    {{ page_num }}
                                </a>
                                {% else %}
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-indigo-50 text-sm font-medium text-indigo-600">
                                    {{ page_num }}
                                </span>
                                {% endif %}
                            {% else %}
                            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                ...
                            </span>
                            {% endif %}
                        {% endfor %}
                        
                        {% if files.has_next %}
                        <a href="{{ url_for('files.file_list', page=files.next_num, search=search, sha=sha_search, status=status_filter, file_type=file_type_filter, root_only=root_only) }}" 
                           class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}

        {% else %}
        <!-- Empty State -->
        <div class="text-center py-12">
            <div class="text-6xl mb-4">📁</div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No files found</h3>
            <p class="text-gray-500 mb-6">
                {% if search or status_filter or file_type_filter %}
                    No files match your current filters. Try adjusting your search criteria.
                {% else %}
                    Get started by uploading your first file for analysis.
                {% endif %}
            </p>
            <div class="space-x-3">
                {% if search or status_filter or file_type_filter %}
                <button onclick="clearAllFilters()" 
                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                    Clear Filters
                </button>
                {% endif %}
                <a href="{{ url_for('files.upload') }}" 
                   class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md">
                    Upload Files
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Bulk Actions Bar (hidden by default) -->
    <div id="bulk-actions-bar" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 hidden">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <span id="selected-count" class="text-sm text-gray-700">0 files selected</span>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="bulkAnalyze()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                    <i class="fas fa-play mr-2"></i>Analyze Selected
                </button>
                <button onclick="bulkDownload()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                    <i class="fas fa-download mr-2"></i>Download Selected
                </button>
                <button onclick="bulkDelete()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                    <i class="fas fa-trash mr-2"></i>Delete Selected
                </button>
                <button onclick="clearSelection()" class="text-gray-600 hover:text-gray-800 px-4 py-2 text-sm">
                    Clear Selection
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Global variables
let selectedFiles = new Set();

// Search functionality
function performSearch() {
    const query = document.getElementById('hyperfast-search').value;
    updateUrl({ search: query, page: 1 });
}

function performMagicSearch() {
    const query = document.getElementById('hyperfast-search').value;
    if (!query) {
        showNotification('Enter a search query first', 'warning');
        return;
    }
    
    showLoading();
    fetch('/api/search/magic', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ query: query })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            // Apply magic search results
            updateUrl({ search: data.enhanced_query, page: 1 });
        } else {
            showNotification('Magic search failed: ' + data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showNotification('Magic search failed', 'error');
    });
}

// Filter management
function updateFilters() {
    const type = document.getElementById('filter-type').value;
    const status = document.getElementById('filter-status').value;
    const size = document.getElementById('filter-size').value;
    const root = document.getElementById('filter-root').value;
    const dateFrom = document.getElementById('filter-date-from').value;
    const dateTo = document.getElementById('filter-date-to').value;
    
    updateUrl({
        file_type: type,
        status: status,
        size: size,
        root_only: root === 'root',
        date_from: dateFrom,
        date_to: dateTo,
        page: 1
    });
}

function clearFilter(filterType) {
    const params = {};
    params[filterType] = '';
    params.page = 1;
    updateUrl(params);
}

function clearAllFilters() {
    updateUrl({
        search: '',
        file_type: '',
        status: '',
        size: '',
        root_only: '',
        date_from: '',
        date_to: '',
        page: 1
    });
}

// Sorting
function updateSort() {
    const sortBy = document.getElementById('sort-by').value;
    const sortOrder = document.getElementById('sort-order').value;
    updateUrl({ sort_by: sortBy, sort_order: sortOrder, page: 1 });
}

// URL management
function updateUrl(params) {
    const url = new URL(window.location);
    Object.keys(params).forEach(key => {
        if (params[key] === '' || params[key] === null || params[key] === false) {
            url.searchParams.delete(key);
        } else {
            url.searchParams.set(key, params[key]);
        }
    });
    window.location.href = url.toString();
}

// File actions
function analyzeFile(sha) {
    showLoading();
    fetch(`/api/analysis/start/${sha}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showNotification(`Analysis started for ${data.filename}`, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showNotification('Failed to start analysis: ' + data.error, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showNotification('Failed to start analysis', 'error');
    });
}

function downloadFile(sha) {
    window.open(`/files/${sha}/download`, '_blank');
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('SHA256 copied to clipboard', 'success', 2000);
    });
}

// Batch operations
function startBatchAnalysis() {
    if (confirm('Start analysis for all pending files?')) {
        showLoading();
        fetch('/api/analysis/batch', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showNotification(`Batch analysis started for ${data.count} files`, 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                showNotification('Failed to start batch analysis', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification('Failed to start batch analysis', 'error');
        });
    }
}

// Selection management
function toggleSelectAll() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.file-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
            selectedFiles.add(checkbox.value);
        } else {
            selectedFiles.delete(checkbox.value);
        }
    });
    
    updateBulkActionsBar();
}

function updateBulkActionsBar() {
    const bar = document.getElementById('bulk-actions-bar');
    const count = document.getElementById('selected-count');
    
    if (selectedFiles.size > 0) {
        bar.classList.remove('hidden');
        count.textContent = `${selectedFiles.size} files selected`;
    } else {
        bar.classList.add('hidden');
    }
}

function clearSelection() {
    selectedFiles.clear();
    document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    updateBulkActionsBar();
}

function bulkAnalyze() {
    if (selectedFiles.size === 0) return;
    
    if (confirm(`Start analysis for ${selectedFiles.size} selected files?`)) {
        showLoading();
        fetch('/api/analysis/bulk', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ file_ids: Array.from(selectedFiles) })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showNotification(`Analysis started for ${data.count} files`, 'success');
                clearSelection();
                setTimeout(() => location.reload(), 2000);
            } else {
                showNotification('Failed to start bulk analysis', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification('Failed to start bulk analysis', 'error');
        });
    }
}

function bulkDownload() {
    if (selectedFiles.size === 0) return;
    
    window.open('/api/files/bulk-download?' + 
                Array.from(selectedFiles).map(id => `ids=${id}`).join('&'), '_blank');
}

function bulkDelete() {
    if (selectedFiles.size === 0) return;
    
    if (confirm(`Delete ${selectedFiles.size} selected files? This action cannot be undone.`)) {
        showLoading();
        fetch('/api/files/bulk-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ file_ids: Array.from(selectedFiles) })
        })
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                showNotification(`${data.count} files deleted`, 'success');
                clearSelection();
                setTimeout(() => location.reload(), 2000);
            } else {
                showNotification('Failed to delete files', 'error');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification('Failed to delete files', 'error');
        });
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Search on Enter key
    document.getElementById('hyperfast-search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // File selection
    document.querySelectorAll('.file-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                selectedFiles.add(this.value);
            } else {
                selectedFiles.delete(this.value);
                document.getElementById('select-all').checked = false;
            }
            updateBulkActionsBar();
        });
    });
    
    // Real-time search suggestions
    let searchTimeout;
    document.getElementById('hyperfast-search').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value;
        
        if (query.length > 2) {
            searchTimeout = setTimeout(() => {
                fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => showSearchSuggestions(data))
                    .catch(error => console.log('Search suggestions failed:', error));
            }, 300);
        } else {
            hideSearchSuggestions();
        }
    });
});

function showSearchSuggestions(data) {
    const container = document.getElementById('search-suggestions');
    if (data.suggestions && data.suggestions.length > 0) {
        container.innerHTML = data.suggestions.map(suggestion => 
            `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer" onclick="applySuggestion('${suggestion}')">${suggestion}</div>`
        ).join('');
        container.classList.remove('hidden');
    } else {
        hideSearchSuggestions();
    }
}

function hideSearchSuggestions() {
    document.getElementById('search-suggestions').classList.add('hidden');
}

function applySuggestion(suggestion) {
    document.getElementById('hyperfast-search').value = suggestion;
    hideSearchSuggestions();
    performSearch();
}

// Auto-refresh file status every 30 seconds
setInterval(function() {
    // Only refresh if there are analyzing files
    if (document.querySelector('.bg-blue-100')) {
        fetch(window.location.href + (window.location.href.includes('?') ? '&' : '?') + 'ajax=1')
            .then(response => response.text())
            .then(html => {
                // Update only the table body
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTbody = doc.querySelector('tbody');
                if (newTbody) {
                    document.querySelector('tbody').innerHTML = newTbody.innerHTML;
                }
            })
            .catch(error => console.log('Auto-refresh failed:', error));
    }
}, 30000);
</script>
{% endblock %}