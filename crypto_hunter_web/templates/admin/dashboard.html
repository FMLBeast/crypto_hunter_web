<!-- admin/dashboard.html -->
{% extends "base.html" %}

{% block title %}Admin Dashboard - Crypto Hunter{% endblock %}

{% block extra_head %}
<style>
    .admin-header {
        background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        color: white;
        border-radius: 12px;
        position: relative;
        overflow: hidden;
    }
    
    .admin-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M20 20c0 4.4-3.6 8-8 8s-8-3.6-8-8 3.6-8 8-8 8 3.6 8 8zm0-20c0 4.4-3.6 8-8 8s-8-3.6-8-8 3.6-8 8-8 8 3.6 8 8z'/%3E%3C/g%3E%3C/svg%3E") repeat;
        z-index: 1;
    }
    
    .admin-content {
        position: relative;
        z-index: 2;
    }
    
    .metric-card {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 24px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--accent-color, #3b82f6), var(--accent-color-light, #60a5fa));
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 8px;
        background: linear-gradient(135deg, var(--accent-color, #3b82f6), var(--accent-color-dark, #1e40af));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .metric-label {
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .metric-change {
        font-size: 0.75rem;
        margin-top: 8px;
        display: flex;
        align-items: center;
    }
    
    .metric-change.positive {
        color: #059669;
    }
    
    .metric-change.negative {
        color: #dc2626;
    }
    
    .admin-table {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }
    
    .admin-table table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .admin-table th {
        background: #f9fafb;
        padding: 16px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .admin-table td {
        padding: 16px;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
    }
    
    .admin-table tr:hover {
        background: #f9fafb;
    }
    
    .admin-table tr:last-child td {
        border-bottom: none;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-active {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-inactive {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .status-pending {
        background: #fef3c7;
        color: #92400e;
    }
    
    .status-processing {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .action-button {
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }
    
    .action-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .action-primary {
        background: #3b82f6;
        color: white;
    }
    
    .action-primary:hover {
        background: #2563eb;
    }
    
    .action-secondary {
        background: #f3f4f6;
        color: #374151;
        border-color: #d1d5db;
    }
    
    .action-secondary:hover {
        background: #e5e7eb;
    }
    
    .action-danger {
        background: #ef4444;
        color: white;
    }
    
    .action-danger:hover {
        background: #dc2626;
    }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 24px;
        height: 400px;
    }
    
    .system-alert {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 1px solid #f59e0b;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 24px;
        display: flex;
        align-items: center;
    }
    
    .system-alert.critical {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-color: #ef4444;
    }
    
    .system-alert.success {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        border-color: #10b981;
    }
    
    .alert-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 16px;
        flex-shrink: 0;
    }
    
    .alert-warning .alert-icon {
        background: #f59e0b;
        color: white;
    }
    
    .alert-critical .alert-icon {
        background: #ef4444;
        color: white;
    }
    
    .alert-success .alert-icon {
        background: #10b981;
        color: white;
    }
    
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
    }
    
    .quick-action-card {
        background: white;
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        color: #374151;
    }
    
    .quick-action-card:hover {
        border-color: #3b82f6;
        background: #eff6ff;
        transform: translateY(-2px);
    }
    
    .quick-action-icon {
        font-size: 2rem;
        margin-bottom: 12px;
        color: #6b7280;
    }
    
    .quick-action-card:hover .quick-action-icon {
        color: #3b82f6;
    }
    
    .performance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }
    
    .performance-card {
        background: white;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        padding: 24px;
    }
    
    .performance-metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .performance-metric:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .performance-bar {
        width: 100%;
        height: 8px;
        background: #f3f4f6;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 8px;
    }
    
    .performance-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        transition: width 0.5s ease;
    }
    
    .log-viewer {
        background: #1f2937;
        color: #e5e7eb;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        padding: 16px;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 16px;
    }
    
    .log-entry {
        margin-bottom: 4px;
        padding: 2px 0;
    }
    
    .log-timestamp {
        color: #9ca3af;
    }
    
    .log-level-INFO {
        color: #60a5fa;
    }
    
    .log-level-WARNING {
        color: #fbbf24;
    }
    
    .log-level-ERROR {
        color: #f87171;
    }
    
    .log-level-DEBUG {
        color: #34d399;
    }
    
    .admin-tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 24px;
        background: white;
        border-radius: 12px 12px 0 0;
        overflow: hidden;
    }
    
    .admin-tab {
        flex: 1;
        padding: 16px 24px;
        text-align: center;
        background: #f9fafb;
        border-right: 1px solid #e5e7eb;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
        color: #6b7280;
    }
    
    .admin-tab:last-child {
        border-right: none;
    }
    
    .admin-tab.active {
        background: white;
        color: #3b82f6;
        border-bottom: 3px solid #3b82f6;
    }
    
    .admin-tab:hover:not(.active) {
        background: #f3f4f6;
        color: #374151;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .maintenance-mode {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border: 2px solid #ef4444;
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        margin-bottom: 32px;
    }
    
    .maintenance-mode h3 {
        color: #991b1b;
        font-size: 1.25rem;
        font-weight: bold;
        margin-bottom: 8px;
    }
    
    .maintenance-mode p {
        color: #7f1d1d;
        margin-bottom: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Admin Header -->
    <div class="admin-header">
        <div class="admin-content p-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-2">
                        <i class="fas fa-shield-alt mr-3"></i>Admin Dashboard
                    </h1>
                    <p class="text-lg opacity-90">System overview and management</p>
                    <div class="flex items-center space-x-4 mt-4 text-sm">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            <span>System Online</span>
                        </div>
                        <span>•</span>
                        <span>Last updated: {{ current_time.strftime('%H:%M:%S') }}</span>
                        <span>•</span>
                        <span>Uptime: {{ system_uptime }}</span>
                    </div>
                </div>
                
                <div class="text-right">
                    <div class="text-sm opacity-75">Welcome back,</div>
                    <div class="text-xl font-semibold">{{ current_user.username }}</div>
                    <div class="text-sm opacity-75">Administrator</div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Alerts -->
    {% if system_alerts %}
    {% for alert in system_alerts %}
    <div class="system-alert alert-{{ alert.level }}">
        <div class="alert-icon">
            <i class="fas fa-{{ alert.icon }}"></i>
        </div>
        <div class="flex-1">
            <h3 class="font-semibold mb-1">{{ alert.title }}</h3>
            <p class="text-sm">{{ alert.message }}</p>
            {% if alert.action_url %}
            <a href="{{ alert.action_url }}" class="text-sm font-medium underline mt-2 inline-block">
                {{ alert.action_text or 'Take Action' }}
            </a>
            {% endif %}
        </div>
        <button onclick="dismissAlert('{{ alert.id }}')" class="text-gray-500 hover:text-gray-700 ml-4">
            <i class="fas fa-times"></i>
        </button>
    </div>
    {% endfor %}
    {% endif %}

    <!-- Maintenance Mode Toggle -->
    {% if maintenance_mode %}
    <div class="maintenance-mode">
        <h3><i class="fas fa-tools mr-2"></i>Maintenance Mode Active</h3>
        <p>The system is currently in maintenance mode. New user registrations and file uploads are disabled.</p>
        <button onclick="toggleMaintenanceMode()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
            <i class="fas fa-power-off mr-2"></i>Disable Maintenance Mode
        </button>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{{ url_for('admin.users') }}" class="quick-action-card">
            <div class="quick-action-icon">
                <i class="fas fa-users"></i>
            </div>
            <h3 class="font-semibold">Manage Users</h3>
            <p class="text-sm text-gray-600">View and manage user accounts</p>
        </a>
        
        <a href="{{ url_for('admin.system_logs') }}" class="quick-action-card">
            <div class="quick-action-icon">
                <i class="fas fa-file-alt"></i>
            </div>
            <h3 class="font-semibold">System Logs</h3>
            <p class="text-sm text-gray-600">View application logs and errors</p>
        </a>
        
        <a href="{{ url_for('admin.analytics') }}" class="quick-action-card">
            <div class="quick-action-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <h3 class="font-semibold">Analytics</h3>
            <p class="text-sm text-gray-600">View usage statistics and metrics</p>
        </a>
        
        <a href="{{ url_for('admin.settings') }}" class="quick-action-card">
            <div class="quick-action-icon">
                <i class="fas fa-cog"></i>
            </div>
            <h3 class="font-semibold">System Settings</h3>
            <p class="text-sm text-gray-600">Configure application settings</p>
        </a>
        
        <button onclick="runSystemCheck()" class="quick-action-card">
            <div class="quick-action-icon">
                <i class="fas fa-stethoscope"></i>
            </div>
            <h3 class="font-semibold">System Health</h3>
            <p class="text-sm text-gray-600">Run comprehensive health check</p>
        </button>
        
        <button onclick="showBackupDialog()" class="quick-action-card">
            <div class="quick-action-icon">
                <i class="fas fa-database"></i>
            </div>
            <h3 class="font-semibold">Backup System</h3>
            <p class="text-sm text-gray-600">Create system backup</p>
        </button>
    </div>

    <!-- Main Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="metric-card" style="--accent-color: #3b82f6; --accent-color-light: #60a5fa; --accent-color-dark: #1e40af;">
            <div class="metric-value">{{ total_users }}</div>
            <div class="metric-label">Total Users</div>
            <div class="metric-change positive">
                <i class="fas fa-arrow-up mr-1"></i>
                +{{ new_users_today }} today
            </div>
        </div>
        
        <div class="metric-card" style="--accent-color: #10b981; --accent-color-light: #34d399; --accent-color-dark: #059669;">
            <div class="metric-value">{{ total_files }}</div>
            <div class="metric-label">Files Analyzed</div>
            <div class="metric-change positive">
                <i class="fas fa-arrow-up mr-1"></i>
                +{{ files_analyzed_today }} today
            </div>
        </div>
        
        <div class="metric-card" style="--accent-color: #f59e0b; --accent-color-light: #fbbf24; --accent-color-dark: #d97706;">
            <div class="metric-value">{{ active_sessions }}</div>
            <div class="metric-label">Active Sessions</div>
            <div class="metric-change">
                <i class="fas fa-clock mr-1"></i>
                {{ avg_session_duration }}min avg
            </div>
        </div>
        
        <div class="metric-card" style="--accent-color: #8b5cf6; --accent-color-light: #a78bfa; --accent-color-dark: #7c3aed;">
            <div class="metric-value">{{ storage_used_gb }}GB</div>
            <div class="metric-label">Storage Used</div>
            <div class="metric-change {{ 'negative' if storage_growth > 10 else 'positive' }}">
                <i class="fas fa-{{ 'arrow-up' if storage_growth > 0 else 'arrow-down' }} mr-1"></i>
                {{ storage_growth }}% this week
            </div>
        </div>
    </div>

    <!-- Performance Overview -->
    <div class="performance-grid">
        <div class="performance-card">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">System Performance</h3>
            <div class="performance-metric">
                <div>
                    <div class="font-medium text-gray-900">CPU Usage</div>
                    <div class="performance-bar">
                        <div class="performance-fill" style="width: {{ cpu_usage }}%"></div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-lg font-bold text-gray-900">{{ cpu_usage }}%</div>
                </div>
            </div>
            
            <div class="performance-metric">
                <div>
                    <div class="font-medium text-gray-900">Memory Usage</div>
                    <div class="performance-bar">
                        <div class="performance-fill" style="width: {{ memory_usage }}%"></div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-lg font-bold text-gray-900">{{ memory_usage }}%</div>
                </div>
            </div>
            
            <div class="performance-metric">
                <div>
                    <div class="font-medium text-gray-900">Disk Usage</div>
                    <div class="performance-bar">
                        <div class="performance-fill" style="width: {{ disk_usage }}%"></div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-lg font-bold text-gray-900">{{ disk_usage }}%</div>
                </div>
            </div>
        </div>
        
        <div class="performance-card">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Analysis Performance</h3>
            <div class="performance-metric">
                <div class="font-medium text-gray-900">Avg Analysis Time</div>
                <div class="text-lg font-bold text-gray-900">{{ avg_analysis_time }}s</div>
            </div>
            
            <div class="performance-metric">
                <div class="font-medium text-gray-900">Queue Length</div>
                <div class="text-lg font-bold text-gray-900">{{ queue_length }}</div>
            </div>
            
            <div class="performance-metric">
                <div class="font-medium text-gray-900">Workers Online</div>
                <div class="text-lg font-bold text-green-600">{{ workers_online }}/{{ total_workers }}</div>
            </div>
            
            <div class="performance-metric">
                <div class="font-medium text-gray-900">Success Rate</div>
                <div class="text-lg font-bold text-gray-900">{{ success_rate }}%</div>
            </div>
        </div>
    </div>

    <!-- Admin Tabs -->
    <div class="admin-tabs">
        <div class="admin-tab active" onclick="switchTab('recent-activity')" data-tab="recent-activity">
            <i class="fas fa-clock mr-2"></i>Recent Activity
        </div>
        <div class="admin-tab" onclick="switchTab('user-management')" data-tab="user-management">
            <i class="fas fa-users mr-2"></i>User Management
        </div>
        <div class="admin-tab" onclick="switchTab('system-logs')" data-tab="system-logs">
            <i class="fas fa-file-alt mr-2"></i>System Logs
        </div>
        <div class="admin-tab" onclick="switchTab('analytics')" data-tab="analytics">
            <i class="fas fa-chart-bar mr-2"></i>Analytics
        </div>
    </div>

    <!-- Recent Activity Tab -->
    <div id="recent-activity-tab" class="tab-content active">
        <div class="admin-table">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Details</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in recent_activities %}
                    <tr>
                        <td>
                            <div class="text-sm text-gray-600">{{ activity.timestamp.strftime('%H:%M:%S') if activity.timestamp else 'Unknown' }}</div>
                            <div class="text-xs text-gray-500">{{ activity.timestamp.strftime('%Y-%m-%d') if activity.timestamp else 'Unknown' }}</div>
                        </td>
                        <td>
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-xs font-semibold">
                                    {{ activity.user.username[0].upper() if activity.user else '?' }}
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">{{ activity.user.username if activity.user else 'Unknown' }}</div>
                                    <div class="text-xs text-gray-500">{{ activity.user.email if activity.user else 'N/A' }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="font-medium text-gray-900">{{ activity.action }}</span>
                        </td>
                        <td>
                            <div class="text-sm text-gray-700">{{ activity.details }}</div>
                            {% if activity.metadata %}
                            <div class="text-xs text-gray-500 mt-1">{{ activity.metadata | tojson }}</div>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status-badge status-{{ activity.status }}">{{ activity.status }}</span>
                        </td>
                        <td>
                            <div class="flex space-x-1">
                                <a href="#" class="action-button action-secondary">
                                    <i class="fas fa-eye mr-1"></i>View
                                </a>
                                {% if activity.can_revert %}
                                <button onclick="revertActivity('{{ activity.id }}')" class="action-button action-danger">
                                    <i class="fas fa-undo mr-1"></i>Revert
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- User Management Tab -->
    <div id="user-management-tab" class="tab-content">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-xl font-semibold text-gray-900">User Management</h2>
                <p class="text-sm text-gray-600">Manage user accounts and permissions</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="exportUsers()" class="action-button action-secondary">
                    <i class="fas fa-download mr-1"></i>Export Users
                </button>
                <button onclick="showCreateUserModal()" class="action-button action-primary">
                    <i class="fas fa-plus mr-1"></i>Create User
                </button>
            </div>
        </div>
        
        <div class="admin-table">
            <table>
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Last Active</th>
                        <th>Files</th>
                        <th>Sessions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in recent_users %}
                    <tr>
                        <td>
                            <div class="flex items-center space-x-2">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold">
                                    {{ user.username[0].upper() }}
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">{{ user.username }}</div>
                                    <div class="text-xs text-gray-500">{{ user.email }}</div>
                                    <div class="text-xs text-gray-400">ID: {{ user.id }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {% if user.is_admin %}bg-purple-100 text-purple-800
                                {% elif user.is_moderator %}bg-blue-100 text-blue-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {% if user.is_admin %}Admin
                                {% elif user.is_moderator %}Moderator
                                {% else %}User{% endif %}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge status-{{ 'active' if user.is_active else 'inactive' }}">
                                {{ 'Active' if user.is_active else 'Inactive' }}
                            </span>
                        </td>
                        <td>
                            <div class="text-sm text-gray-700">{{ user.last_seen.strftime('%Y-%m-%d %H:%M') if user.last_seen else 'Never' }}</div>
                        </td>
                        <td>
                            <span class="text-sm font-medium">{{ user.file_count or 0 }}</span>
                        </td>
                        <td>
                            <span class="text-sm font-medium">{{ user.session_count or 0 }}</span>
                        </td>
                        <td>
                            <div class="flex space-x-1">
                                <a href="{{ url_for('admin.user_detail', user_id=user.id) }}" class="action-button action-secondary">
                                    <i class="fas fa-eye mr-1"></i>View
                                </a>
                                <button onclick="editUser('{{ user.id }}')" class="action-button action-primary">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                                {% if not user.is_admin %}
                                <button onclick="toggleUserStatus('{{ user.id }}')" class="action-button action-danger">
                                    <i class="fas fa-{{ 'ban' if user.is_active else 'check' }} mr-1"></i>
                                    {{ 'Disable' if user.is_active else 'Enable' }}
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- System Logs Tab -->
    <div id="system-logs-tab" class="tab-content">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-xl font-semibold text-gray-900">System Logs</h2>
                <p class="text-sm text-gray-600">Monitor system events and errors</p>
            </div>
            <div class="flex space-x-3">
                <select id="log-level-filter" class="px-3 py-1 border border-gray-300 rounded text-sm">
                    <option value="">All Levels</option>
                    <option value="DEBUG">Debug</option>
                    <option value="INFO">Info</option>
                    <option value="WARNING">Warning</option>
                    <option value="ERROR">Error</option>
                </select>
                <button onclick="refreshLogs()" class="action-button action-secondary">
                    <i class="fas fa-refresh mr-1"></i>Refresh
                </button>
                <button onclick="downloadLogs()" class="action-button action-primary">
                    <i class="fas fa-download mr-1"></i>Download
                </button>
            </div>
        </div>
        
        <div class="bg-white rounded-lg border border-gray-200">
            <div class="log-viewer" id="log-viewer">
                {% for log_entry in recent_logs %}
                <div class="log-entry">
                    <span class="log-timestamp">{{ log_entry.timestamp.strftime('%H:%M:%S.%f')[:-3] if log_entry.timestamp else 'Unknown' }}</span>
                    <span class="log-level-{{ log_entry.level }}"> [{{ log_entry.level }}]</span>
                    <span> {{ log_entry.message }}</span>
                    {% if log_entry.source %}
                    <span class="text-gray-400"> - {{ log_entry.source }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics-tab" class="tab-content">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="chart-container">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Daily Activity</h3>
                <canvas id="daily-activity-chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">File Types Distribution</h3>
                <canvas id="file-types-chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">User Growth</h3>
                <canvas id="user-growth-chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Analysis Success Rate</h3>
                <canvas id="success-rate-chart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Modals would go here -->
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Tab switching
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.admin-tab').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').classList.add('active');
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
}

// System actions
function toggleMaintenanceMode() {
    if (confirm('Are you sure you want to toggle maintenance mode?')) {
        fetch('/api/admin/maintenance-mode', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  location.reload();
              } else {
                  alert('Failed to toggle maintenance mode');
              }
          });
    }
}

function runSystemCheck() {
    const button = event.target;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Running...';
    button.disabled = true;
    
    fetch('/api/admin/system-check', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    }).then(response => response.json())
      .then(data => {
          alert(`System check completed:\n${data.results.join('\n')}`);
          button.innerHTML = '<div class="quick-action-icon"><i class="fas fa-stethoscope"></i></div><h3 class="font-semibold">System Health</h3><p class="text-sm text-gray-600">Run comprehensive health check</p>';
          button.disabled = false;
      });
}

// User management
function editUser(userId) {
    window.location.href = `/admin/users/${userId}/edit`;
}

function toggleUserStatus(userId) {
    if (confirm('Are you sure you want to change this user\'s status?')) {
        fetch(`/api/admin/users/${userId}/toggle-status`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  location.reload();
              } else {
                  alert('Failed to toggle user status');
              }
          });
    }
}

function exportUsers() {
    window.location.href = '/api/admin/users/export';
}

// Log management
function refreshLogs() {
    const logViewer = document.getElementById('log-viewer');
    logViewer.innerHTML = '<div class="text-center text-gray-500">Loading logs...</div>';
    
    fetch('/api/admin/logs/recent')
        .then(response => response.json())
        .then(data => {
            logViewer.innerHTML = data.logs.map(log => 
                `<div class="log-entry">
                    <span class="log-timestamp">${log.timestamp}</span>
                    <span class="log-level-${log.level}"> [${log.level}]</span>
                    <span> ${log.message}</span>
                    ${log.source ? `<span class="text-gray-400"> - ${log.source}</span>` : ''}
                </div>`
            ).join('');
        });
}

function downloadLogs() {
    window.location.href = '/api/admin/logs/download';
}

// Analytics charts
function initCharts() {
    // Daily Activity Chart
    const dailyActivityCtx = document.getElementById('daily-activity-chart').getContext('2d');
    new Chart(dailyActivityCtx, {
        type: 'line',
        data: {
            labels: {{ daily_activity_labels | tojson | safe }},
            datasets: [{
                label: 'User Activity',
                data: {{ daily_activity_data | tojson | safe }},
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // File Types Chart
    const fileTypesCtx = document.getElementById('file-types-chart').getContext('2d');
    new Chart(fileTypesCtx, {
        type: 'doughnut',
        data: {
            labels: {{ file_types_labels | tojson | safe }},
            datasets: [{
                data: {{ file_types_data | tojson | safe }},
                backgroundColor: [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // User Growth Chart
    const userGrowthCtx = document.getElementById('user-growth-chart').getContext('2d');
    new Chart(userGrowthCtx, {
        type: 'bar',
        data: {
            labels: {{ user_growth_labels | tojson | safe }},
            datasets: [{
                label: 'New Users',
                data: {{ user_growth_data | tojson | safe }},
                backgroundColor: '#10b981'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Success Rate Chart
    const successRateCtx = document.getElementById('success-rate-chart').getContext('2d');
    new Chart(successRateCtx, {
        type: 'line',
        data: {
            labels: {{ success_rate_labels | tojson | safe }},
            datasets: [{
                label: 'Success Rate (%)',
                data: {{ success_rate_data | tojson | safe }},
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

// Real-time updates
function startRealTimeUpdates() {
    setInterval(() => {
        // Update metrics
        fetch('/api/admin/metrics/live')
            .then(response => response.json())
            .then(data => {
                // Update metric values
                Object.keys(data.metrics).forEach(key => {
                    const element = document.querySelector(`[data-metric="${key}"]`);
                    if (element) {
                        element.textContent = data.metrics[key];
                    }
                });
            });
        
        // Update system status
        fetch('/api/admin/system/status')
            .then(response => response.json())
            .then(data => {
                // Update performance bars
                const cpuBar = document.querySelector('[data-metric="cpu"] .performance-fill');
                const memoryBar = document.querySelector('[data-metric="memory"] .performance-fill');
                const diskBar = document.querySelector('[data-metric="disk"] .performance-fill');
                
                if (cpuBar) cpuBar.style.width = data.cpu_usage + '%';
                if (memoryBar) memoryBar.style.width = data.memory_usage + '%';
                if (diskBar) diskBar.style.width = data.disk_usage + '%';
            });
    }, 30000); // Update every 30 seconds
}

// Initialize everything
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts when analytics tab is first shown
    document.querySelector('[data-tab="analytics"]').addEventListener('click', function() {
        setTimeout(initCharts, 100);
    }, { once: true });
    
    // Start real-time updates
    startRealTimeUpdates();
    
    // Auto-refresh logs
    document.getElementById('log-level-filter').addEventListener('change', function() {
        // Filter logs by level
        const level = this.value;
        const logEntries = document.querySelectorAll('.log-entry');
        
        logEntries.forEach(entry => {
            if (level === '' || entry.textContent.includes(`[${level}]`)) {
                entry.style.display = 'block';
            } else {
                entry.style.display = 'none';
            }
        });
    });
});

// Alert management
function dismissAlert(alertId) {
    fetch(`/api/admin/alerts/${alertId}/dismiss`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}'
        }
    }).then(() => {
        event.target.closest('.system-alert').remove();
    });
}
</script>
{% endblock %}